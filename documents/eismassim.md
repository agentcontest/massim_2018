# EISMASSim Documentation

_EISMASSim_ is based on the [Environment Interface Standard](https://github.com/eishub/) (EIS), a proposed standard for agent-environment interaction.

It maps the communication between agents and the _MASSim_ server, (i.e. sending and receiving XML-messages), to Java method calls. Also, it automatically establishes and maintains connections to a specified _MASSim_ server.

In other words, _EISMASSim_ is a proxy environment on the client side which handles communication with the _MASSim_ server completely by itself.

## Using EISMASSim

#### Include the library

_EISMASSim_ is packaged as a jar file `eismassim-X.Y-jar-with-dependencies.jar` which already includes the _EIS_ package. The easiest way would be to include the jar with dependencies in your classpath. If you want to manage dependencies yourself, use `eismassim-X.Y.jar`. You can get the required EIS version (0.5.0) from the [eishub](https://github.com/eishub/eis).

#### Create and start the Environment Interface instance

```Java
EnvironmentInterfaceStandard ei = new EnvironmentInterface();
```

The environment interface needs a configuration file to know how many entities it has to create. In the above case, an `eismassimconfig.json` file is expected in the working directory. Alternatively, the path to a configuration file can be given to the constructor.

```Java
try {
  ei.start();
} catch (ManagementException e) {
  // TODO handle the exception
}
```

This sets the state of the interface to `RUNNING`.

#### Register your agents

Each agent you want to connect needs to be registered with the interface.

```Java
try {
  ei.registerAgent(agentName);
} catch (AgentException e) {
  // TODO handle the exception
}
```

#### Associate agents with entities

Entities are the _corporeal_ parts used for perceiving and acting, i.e. the vehicles in the simulation. The available entities are specified in the `eismassimconfig.json` file which needs to match the _MASSim_ scenario requirements.

```Java
try {
  ei.associateEntity(agentName, entityName);
} catch (RelationException e) {
  // TODO handle the exception
}
```

This part automatically triggers authentication of the associated entity with the _MASSim_ server.

#### Perceive the environment

Percepts can either be _polled_ or received as _notifications_.

```Java
try {
  eis.getAllPercepts(agentName);
} catch (PerceiveException e) {
  // TODO handle the exception
}
```

This would retrieve all percepts for the agent named `agentName`. The return value is a map, since the agent could be associated with more than one entity.

#### Execute actions

```Java
Action action = new Action(...);
try {
  ei.performAction(agentName, action);
} catch (ActException e) {
  // TODO handle the exception
}
```

To execute an action, the name of the agent executing the action and the action itself need to be passed. All entities associated with the agent will perform this action (if possible).

## Configuration

The configuration of _EISMASSim_ is now realized with JSON files, matching the configuration of the _MASSim_ server.

Configuration example:

```JSON
{
  "scenario": "city2017",
  "host": "localhost",
  "port": 12300,
  "scheduling": true,
  "timeout": 40000,
  "times": false,
  "notifications": false,
  "queued": false,
  "entities": [
    {
      "name": "connectionA1",
      "username": "agentA1",
      "password": "1",
      "iilang": false,
      "xml": true}
  ]
}
```

In the above example, only one entity is configured for the sake of readability. (Usually, way more entities are listed there.)

The main entries are:

* __scenario:__ the name of the MAPC scenario to handle (determines how XML messages are translated)
* __host:__ address of a _MASSim_ server
* __port:__ port the _MASSim_ server is listening on
* __scheduling:__ if `true`, an action can only be sent if a valid action-id is available; calls to `performAction` will also block until such an ID becomes available; it is recommended to not disable this
* __timeout:__ the timeout to use in combination with __scheduling__ while waiting for `performAction`
* __queued:__ if enabled, `getAllPercepts` will only yield one collection of percepts for each call (i.e. one for all percepts from a `SIM-START` message, one for all percepts from a `REQUEST-ACTION` message, etc.) in the same order as they were received from the _MASSim_ server
* __times:__ if enabled, percepts will be annotated with the time they were generated by the server
* __notifications:__ if enabled, percepts will be delivered as notifications; this is detailed in the description of _EIS_

Further, there is an object for each entity in the `entities` array, containing

* __name:__ the name of the entity
* __username:__ the name to authenticate with
* __password:__ the password to authenticate with (both as configured in the _MASSim_ server)
* __iilang:__ whether to print the IILang version of received percepts
* __xml:__ whether to print XML messages sent and received by the interface

## Example usage

EISMASSim is exemplarily used in the [javaagents](javaagents.md) package.

## MAPC 2017 scenario

### Actions

The actions for the current scenario can be reviewed in [scenario.md](scenario.md). An IILang action takes a name and a number or parameters. Just pass the required parameters in the same order as described in
[scenario.md](scenario.md).

Example:

```Java
Action a = new Action("goto", new Identifier("shop1"));
```

### Percepts

The following paragraphs describe how the XML messages described in [protocol.md](protocol.md) and [scenario.md](scenario.md) are translated into __IILang__ percepts.

#### SIM-START percepts

The following percepts might be included in a `SIM-START` message:

TODO

#### REQUEST-ACTION percepts

The following percepts might be included in a `REQUEST-ACTION` message:

TODO

#### SIM-END percepts

The following percepts might be included in a `SIM-END` message:

TODO
